<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Kamera IDN Pamijahan</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap");

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: #f0f2f5;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
      }

      .orientation-alert {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 20px;
        z-index: 9999;
        font-size: 1.2rem;
      }

      @media (max-width: 767px) and (orientation: portrait) {
        .orientation-alert {
          display: flex;
        }
      }

      .container {
        width: 100%;
        max-width: 1400px;
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
        margin: 0 auto;
      }

      @media (min-width: 768px) {
        .container {
          flex-direction: row;
          height: 95vh;
          max-height: 100vh;
        }
      }

      .left-section {
        flex: 1;
        min-height: 300px;
        position: relative;
      }

      .right-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding: 0.5rem;
        min-width: 300px;
      }

      @media (min-width: 768px) {
        .left-section {
          flex: 7;
        }
        .right-section {
          flex: 3;
        }
      }

      @media (max-width: 767px) {
        .right-section {
          padding: 0;
        }
      }

      video,
      canvas,
      #previewImage {
        display: block;
        width: 100%;
        height: 100%;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        background-color: #000;
        object-fit: cover;
      }

      .camera-container {
        position: relative;
        width: 100%;
        height: 100%;
        background-color: #000;
        border-radius: 1rem;
        overflow: hidden;
      }

      .hidden-download {
        display: none;
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .button-group {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        width: 100%;
      }

      @media (min-width: 768px) {
        .button-group {
          gap: 1rem;
        }
      }

      .btn {
        width: 100%;
        font-weight: bold;
        padding: 0.8rem;
        border-radius: 9999px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .btn:active {
        transform: scale(0.98);
      }

      .btn-capture {
        background-color: #2563eb;
        color: white;
      }

      .btn-capture:hover {
        background-color: #1d4ed8;
      }

      .btn-retake {
        background-color: #6b7280;
        color: white;
      }

      .btn-retake:hover {
        background-color: #4b5563;
      }

      .btn-save {
        background-color: #10b981;
        color: white;
      }

      .btn-save:hover {
        background-color: #059669;
      }

      .flip-btn {
        position: absolute;
        top: 0.8rem;
        right: 0.8rem;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
        border-radius: 1rem;
        display: none;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .header {
        text-align: center;
        padding: 0.5rem 0;
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: bold;
        color: #1e40af;
        margin-bottom: 0.25rem;
      }

      .header p {
        color: #4b5563;
        font-size: 0.875rem;
      }

      .input-container {
        width: 100%;
      }

      .input-container label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        color: #374151;
        font-weight: 500;
      }

      .input-container input {
        width: 100%;
        padding: 0.8rem 1rem;
        background-color: #f9fafb;
        border: 1px solid #d1d5db;
        border-radius: 9999px;
        font-size: 0.9rem;
      }

      .input-container input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      }

      .preview-container {
        display: none;
        width: 100%;
        height: 100%;
        border-radius: 1rem;
        overflow: hidden;
      }

      .preview-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .hidden {
        display: none;
      }

      .flex {
        display: flex;
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 6px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb {
        background: #c5c5c5;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    </style>
  </head>
  <body class="flex items-center justify-center min-h-screen p-2 sm:p-4">
    <!-- Orientation alert -->
    <div class="orientation-alert">
      <div>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-16 w-16 mx-auto mb-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
        </svg>
        <p class="text-xl font-medium mb-2">
          Mohon putar perangkat Anda ke mode landscape
        </p>
        <p class="text-gray-300">
          Untuk pengalaman terbaik, gunakan perangkat dalam orientasi landscape
        </p>
      </div>
    </div>

    <div class="container bg-white rounded-2xl shadow-xl overflow-hidden">
      <div class="left-section">
        <div class="camera-container">
          <!-- Camera View -->
          <div id="cameraView">
            <video id="cameraFeed" autoplay playsinline></video>
            <canvas
              id="photoCanvas"
              class="hidden absolute top-0 left-0"></canvas>

            <!-- Flip Camera Button -->
            <button id="flipCameraButton" class="flip-btn">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 text-blue-800"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
              </svg>
            </button>
          </div>

          <!-- Preview View -->
          <div id="previewView" class="preview-container">
            <img id="previewImage" class="fade-in" src="" alt="Preview Foto" />
          </div>

          <!-- Loading Indicator -->
          <div id="loadingIndicator" class="loading-overlay">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

      <div class="right-section">
        <!-- Header -->
        <div class="header">
          <h1>PMJ TimeStamp System</h1>
        </div>

        <!-- Input Nama Guru -->
        <div class="input-container" id="inputContainer">
          <label for="namaGuru">Nama Guru:</label>
          <input
            type="text"
            id="namaGuru"
            placeholder="Masukkan nama guru..." />
        </div>

        <!-- Buttons -->
        <div class="button-group">
          <!-- Capture Button -->
          <button id="captureButton" class="btn btn-capture">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>

          <!-- Preview Buttons -->
          <div id="previewButtons" class="button-group hidden">
            <button id="retakeButton" class="btn btn-retake">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            </button>
            <button id="saveButton" class="btn btn-save">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
              </svg>
            </button>
            <button id="shareButton" class="btn btn-save">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 12v.01M12 4v.01M20 12v.01M12 20v.01M16.24 7.76l-.01-.01M7.76 16.24l-.01-.01M16.24 16.24l-.01-.01M7.76 7.76l-.01-.01" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden Download Link -->
    <a id="downloadLink" class="hidden-download"></a>

    <script>
      // Mendapatkan elemen-elemen DOM
      const cameraFeed = document.getElementById("cameraFeed");
      const photoCanvas = document.getElementById("photoCanvas");
      const namaGuruInput = document.getElementById("namaGuru");
      const captureButton = document.getElementById("captureButton");
      const saveButton = document.getElementById("saveButton");
      const retakeButton = document.getElementById("retakeButton");
      const downloadLink = document.getElementById("downloadLink");
      const loadingIndicator = document.getElementById("loadingIndicator");
      const cameraView = document.getElementById("cameraView");
      const previewView = document.getElementById("previewView");
      const previewImage = document.getElementById("previewImage");
      const previewButtons = document.getElementById("previewButtons");
      const inputContainer = document.getElementById("inputContainer");
      const flipCameraButton = document.getElementById("flipCameraButton");

      let cameraStream = null;
      let cameraFacingMode = "environment"; // Default: kamera belakang
      let logoImage = new Image();
      let logoUrl =
        "https://idn.sch.id/wp-content/uploads/2024/01/f0afb4b719f34cf6b147d499f50adddd.png";
      let currentPosition = { latitude: null, longitude: null };

      // Fungsi untuk mengambil nama guru dari localStorage
      const getNamaGuru = () => {
        return localStorage.getItem("namaGuru") || "";
      };

      // Fungsi untuk menyimpan nama guru ke localStorage
      const saveNamaGuru = () => {
        localStorage.setItem("namaGuru", namaGuruInput.value);
      };

      // Pemuatan logo dari URL eksternal
      loadingIndicator.style.display = "flex";
      logoImage.crossOrigin = "anonymous";
      logoImage.onload = () => {
        console.log("Logo berhasil dimuat.");
        loadingIndicator.style.display = "none";
        initCamera();
      };
      logoImage.onerror = () => {
        console.error("Gagal memuat logo. Menggunakan fallback.");
        loadingIndicator.style.display = "none";
        initCamera();
      };
      logoImage.src = logoUrl;

      // Mengisi input nama guru saat aplikasi dimuat
      namaGuruInput.value = getNamaGuru();
      namaGuruInput.addEventListener("input", saveNamaGuru);

      // Fungsi untuk mendapatkan lokasi pengguna
      const getLocation = () => {
        return new Promise((resolve, reject) => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                currentPosition.latitude = position.coords.latitude.toFixed(6);
                currentPosition.longitude =
                  position.coords.longitude.toFixed(6);
                console.log("Lokasi didapatkan:", currentPosition);
                resolve(true);
              },
              (error) => {
                if (error.code === error.PERMISSION_DENIED) {
                  showCustomAlert(
                    "Izin lokasi diperlukan untuk menggunakan kamera. Mohon aktifkan lokasi dan muat ulang halaman."
                  );
                } else {
                  showCustomAlert(
                    "Gagal mendapatkan lokasi. Mohon periksa pengaturan lokasi Anda."
                  );
                }
                currentPosition.latitude = null;
                currentPosition.longitude = null;
                reject(error);
              }
            );
          } else {
            showCustomAlert("Browser Anda tidak mendukung geolokasi.");
            reject(new Error("Geolocation not supported"));
          }
        });
      };

      // Panggil fungsi lokasi saat halaman dimuat
      getLocation();

      // Fungsi untuk memulai/mengaktifkan kamera
      const initCamera = async () => {
        try {
          // Cek lokasi terlebih dahulu
          await getLocation();

          if (cameraStream) {
            cameraStream.getTracks().forEach((track) => track.stop());
          }

          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error(
              "Browser Anda tidak mendukung WebRTC (getUserMedia)."
            );
          }

          const constraints = {
            video: {
              facingMode: cameraFacingMode,
            },
          };

          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          cameraStream = stream;
          cameraFeed.srcObject = stream;
          await new Promise((resolve) => {
            cameraFeed.onloadedmetadata = () => {
              showCameraView();
              resolve();
            };
          });
        } catch (err) {
          console.error("Error:", err);
          showCustomAlert(
            err.message || "Terjadi kesalahan saat mengakses kamera."
          );
          return;
        }
      };

      // Fungsi untuk membalik kamera
      const flipCamera = () => {
        cameraFacingMode =
          cameraFacingMode === "environment" ? "user" : "environment";
        initCamera();
      };

      // Fungsi untuk menampilkan tampilan kamera
      const showCameraView = () => {
        cameraView.style.display = "block";
        previewView.style.display = "none";
        captureButton.style.display = "flex";
        previewButtons.style.display = "none";
        inputContainer.style.display = "block";
      };

      // Fungsi untuk menampilkan tampilan pratinjau
      const showPreviewView = (imageDataUrl) => {
        cameraView.style.display = "none";
        previewImage.src = imageDataUrl;
        previewView.style.display = "block";
        captureButton.style.display = "none";
        previewButtons.style.display = "flex";
        inputContainer.style.display = "none";
      };

      // Fungsi untuk menghasilkan string acak
      const generateRandomString = (length) => {
        const characters =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        let result = "";
        for (let i = 0; i < length; i++) {
          result += characters.charAt(
            Math.floor(Math.random() * characters.length)
          );
        }
        return result;
      };

      // Fungsi untuk menghasilkan QR Code
      const generateQRCode = (data, size = 128) => {
        return new Promise((resolve) => {
          // Buat elemen div sementara
          const tempDiv = document.createElement("div");
          tempDiv.style.position = "absolute";
          tempDiv.style.left = "-9999px";
          document.body.appendChild(tempDiv);

          // Buat QRCode di dalam div
          const qr = new QRCode(tempDiv, {
            text: data,
            width: size,
            height: size,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H,
          });

          // Tunggu sampai QRCode selesai dirender ke dalam img/canvas
          setTimeout(() => {
            // Cari elemen img atau canvas di dalam tempDiv
            let qrImg = tempDiv.querySelector("img");
            let qrCanvas = tempDiv.querySelector("canvas");
            let qrElement = qrImg || qrCanvas;
            if (qrElement) {
              // Buat canvas baru dan gambar QR ke dalamnya
              const canvas = document.createElement("canvas");
              canvas.width = size;
              canvas.height = size;
              const ctx = canvas.getContext("2d");
              if (qrImg) {
                // Jika QRCode berupa img
                qrImg.onload = () => {
                  ctx.drawImage(qrImg, 0, 0, size, size);
                  document.body.removeChild(tempDiv);
                  resolve(canvas);
                };
                // Jika sudah ter-load, langsung gambar
                if (qrImg.complete) {
                  ctx.drawImage(qrImg, 0, 0, size, size);
                  document.body.removeChild(tempDiv);
                  resolve(canvas);
                }
              } else if (qrCanvas) {
                // Jika QRCode berupa canvas
                ctx.drawImage(qrCanvas, 0, 0, size, size);
                document.body.removeChild(tempDiv);
                resolve(canvas);
              }
            } else {
              document.body.removeChild(tempDiv);
              resolve(null);
            }
          }, 100); // Delay kecil agar QRCode sempat dirender
        });
      };

      // Fungsi untuk mengambil foto dan menambahkan watermark
      const capturePhoto = async () => {
        if (!cameraStream) {
          showCustomAlert("Kamera belum aktif!");
          return;
        }

        // Canvas untuk foto mentah dari kamera
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = cameraFeed.videoWidth;
        tempCanvas.height = cameraFeed.videoHeight;
        const tempCtx = tempCanvas.getContext("2d");

        // Perbaiki orientasi jika menggunakan kamera depan
        if (cameraFacingMode === "user") {
          tempCtx.save();
          tempCtx.scale(-1, 1);
          tempCtx.drawImage(
            cameraFeed,
            -tempCanvas.width,
            0,
            tempCanvas.width,
            tempCanvas.height
          );
          tempCtx.restore();
        } else {
          tempCtx.drawImage(
            cameraFeed,
            0,
            0,
            tempCanvas.width,
            tempCanvas.height
          );
        }

        // Canvas akhir untuk photocard
        const cardCanvas = photoCanvas;
        const photoWidth = tempCanvas.width;
        const photoHeight = tempCanvas.height;

        const frameMargin = photoWidth * 0.05;
        const bottomFrameHeight = photoHeight * 0.2;

        const cardWidth = photoWidth + frameMargin * 2;
        const cardHeight = photoHeight + frameMargin + bottomFrameHeight;

        cardCanvas.width = cardWidth;
        cardCanvas.height = cardHeight;
        const cardCtx = cardCanvas.getContext("2d");

        // Menggambar bingkai putih solid
        cardCtx.fillStyle = "#ffffff";
        cardCtx.fillRect(0, 0, cardWidth, cardHeight);

        // Menggambar foto ke dalam bingkai
        cardCtx.drawImage(
          tempCanvas,
          frameMargin,
          frameMargin,
          photoWidth,
          photoHeight
        );

        // Mendefinisikan properti untuk watermark
        const guruName = namaGuruInput.value || "Guru tidak bernama";
        const date = new Date();
        const days = [
          "Minggu",
          "Senin",
          "Selasa",
          "Rabu",
          "Kamis",
          "Jumat",
          "Sabtu",
        ];
        const dayName = days[date.getDay()];

        const timestamp = `${dayName}, ${date
          .toLocaleString("id-ID", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          })
          .replace(/\./g, ":")}`;

        const locationText = "IDN Pamijahan";
        const watermarkText = `@byIDNPamijahanSystem`;

        // Area untuk watermark di dalam foto
        const watermarkAreaX = frameMargin;
        const watermarkAreaY = frameMargin;
        const watermarkAreaWidth = photoWidth;
        const watermarkAreaHeight = photoHeight;

        // Menggambar logo di kiri atas foto
        if (logoImage.complete && logoImage.naturalHeight !== 0) {
          const logoSize = watermarkAreaWidth * 0.18; // Memperbesar ukuran logo
          const logoHeight =
            (logoImage.naturalHeight / logoImage.naturalWidth) * logoSize;
          cardCtx.globalAlpha = 0.9; // Meningkatkan opacity sedikit
          cardCtx.drawImage(
            logoImage,
            watermarkAreaX + frameMargin,
            watermarkAreaY + frameMargin,
            logoSize,
            logoHeight
          );
          cardCtx.globalAlpha = 1.0;
        }

        // Menggambar area teks di kanan atas foto
        const textLines = [guruName, timestamp];
        const textFontSize = watermarkAreaHeight * 0.037; // Ukuran font sedikit lebih besar
        const textFont = `bold ${textFontSize}px 'Inter', sans-serif`;
        const textLineHeight = textFontSize * 1.2; // Jarak antar baris lebih rapat
        const textPadding = 10;
        const textXEnd = watermarkAreaX + watermarkAreaWidth - frameMargin;
        let textYStart = watermarkAreaY + frameMargin;

        cardCtx.font = textFont;
        cardCtx.textBaseline = "top";
        cardCtx.textAlign = "right";

        const textWidths = textLines.map(
          (line) => cardCtx.measureText(line).width
        );
        const maxTextWidth = Math.max(...textWidths);
        const textBgWidth = maxTextWidth + textPadding * 2;
        const textBgHeight = textLines.length * textLineHeight + textPadding;

        cardCtx.fillStyle = "rgba(0, 0, 0, 0.5)";
        cardCtx.beginPath();
        cardCtx.roundRect(
          textXEnd - textBgWidth,
          textYStart,
          textBgWidth,
          textBgHeight,
          10
        );
        cardCtx.fill();

        cardCtx.fillStyle = "#ffffff";
        let textY = textYStart + textPadding / 2;
        for (const line of textLines) {
          cardCtx.fillText(line, textXEnd - textPadding, textY);
          textY += textLineHeight;
        }

        // Menggambar QR Code di sudut kiri bawah foto
        // Generate unique identifiers
        const qrPrefix = generateRandomString(8);
        const qrSuffix = generateRandomString(8);
        const timestamp_encoded = btoa(timestamp);
        const location_encoded = btoa(locationText);
        const name_encoded = btoa(guruName);

        // Create a more secure format with Base64 encoding and checksums
        const qrCodeData = `IDN${qrPrefix}#${name_encoded}#${timestamp_encoded}#${location_encoded}#${qrSuffix}`;
        const qrCodeSize = watermarkAreaWidth * 0.14; // Ukuran QR yang lebih kecil
        // Generate QR dengan ukuran 2.5x untuk kualitas lebih baik
        const qrCodeCanvas = await generateQRCode(qrCodeData, qrCodeSize * 2.5);

        // Menambahkan frame putih untuk QR code
        const qrFramePadding = qrCodeSize * 0.2; // Padding lebih besar untuk frame putih

        // Gambar background putih untuk QR
        cardCtx.fillStyle = "#ffffff";
        cardCtx.fillRect(
          watermarkAreaX + frameMargin - qrFramePadding,
          watermarkAreaY +
            watermarkAreaHeight -
            qrCodeSize -
            frameMargin -
            qrFramePadding,
          qrCodeSize + qrFramePadding * 2,
          qrCodeSize + qrFramePadding * 2
        );

        // Gambar QR code
        cardCtx.drawImage(
          qrCodeCanvas,
          watermarkAreaX + frameMargin,
          watermarkAreaY + watermarkAreaHeight - qrCodeSize - frameMargin,
          qrCodeSize,
          qrCodeSize
        );

        // Menggambar watermark di bingkai bawah dengan style yang lebih elegan
        cardCtx.fillStyle = "#1e40af"; // Warna biru tua yang lebih elegan
        cardCtx.font = `600 ${bottomFrameHeight * 0.2}px 'Inter', sans-serif`; // Ukuran lebih kecil, weight medium
        cardCtx.textAlign = "center";
        cardCtx.textBaseline = "middle";

        // Menambah bayangan teks untuk kedalaman
        cardCtx.shadowColor = "rgba(0, 0, 0, 0.2)";
        cardCtx.shadowBlur = 2;
        cardCtx.shadowOffsetX = 1;
        cardCtx.shadowOffsetY = 1;

        cardCtx.fillText(
          watermarkText,
          cardWidth / 2,
          cardHeight - bottomFrameHeight / 2
        );

        // Reset shadow
        cardCtx.shadowColor = "transparent";
        cardCtx.shadowBlur = 0;
        cardCtx.shadowOffsetX = 0;
        cardCtx.shadowOffsetY = 0;

        // Tampilkan pratinjau
        const imageDataURL = cardCanvas.toDataURL("image/png");
        showPreviewView(imageDataURL);

        // Hentikan stream kamera
        if (cameraStream) {
          cameraStream.getTracks().forEach((track) => track.stop());
          cameraStream = null;
        }
      };

      // Fungsi untuk menyimpan foto
      const savePhoto = () => {
        const imageDataURL = photoCanvas.toDataURL("image/png");
        downloadLink.href = imageDataURL;
        downloadLink.download = `foto_idn_pamijahan_${new Date().getTime()}.png`;
        downloadLink.click();

        // Kembali ke tampilan kamera
        initCamera();
        getLocation();
      };

      // Fungsi untuk mengambil ulang foto
      const retakePhoto = () => {
        initCamera();
        getLocation();
      };

      // Fungsi untuk berbagi foto
      const sharePhoto = async () => {
        if (navigator.share) {
          const imageDataURL = photoCanvas.toDataURL("image/png");
          const blob = await (await fetch(imageDataURL)).blob();
          const file = new File(
            [blob],
            `foto_idn_pamijahan_${new Date().getTime()}.png`,
            { type: blob.type }
          );

          try {
            await navigator.share({
              files: [file],
              title: "Foto IDN Pamijahan",
              text: "Berikut adalah foto yang diambil menggunakan aplikasi IDN Pamijahan.",
            });
            console.log("Foto berhasil dibagikan.");
          } catch (error) {
            console.error("Gagal membagikan foto:", error);
          }
        } else {
          alert("Fitur berbagi tidak didukung di perangkat ini.");
        }
      };

      // Event Listeners untuk tombol
      captureButton.addEventListener("click", capturePhoto);
      saveButton.addEventListener("click", savePhoto);
      retakeButton.addEventListener("click", retakePhoto);
      flipCameraButton.addEventListener("click", flipCamera);
      const shareButton = document.getElementById("shareButton");
      shareButton.addEventListener("click", sharePhoto);

      // Fungsi modal kustom (untuk menggantikan alert)
      function showCustomAlert(message) {
        alert(message);
      }

      // Inisialisasi kamera saat halaman dimuat
      window.addEventListener("load", initCamera);
    </script>
  </body>
</html>
